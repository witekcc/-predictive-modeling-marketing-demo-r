---
title: "Budowa klasyfikatora dla problemu klasyfikacji odbiorców reklam"
---
Na początek należy ustawić ścieżkę do pliku w którym znajdują się pliki zawierające dane z reklam
```{r cache=TRUE}
path <- "C:/_Projects/DataAnalysis/R/emas/reklamy_emas"
setwd(path) 
```

Całą poniższą operację wczytywania danych można zautomatyzować, tak więc pobieranie danych dla większej ilości reklam nie bedzie problemem.<br>

Wczytywanie danych, zmieniłam nazawy poszczególnych plików na r1.csv, r2.csv itd...
```{r cache=TRUE}
r1 <- read.csv("r1.csv", header = TRUE)
r2 <- read.csv("r2.csv", header = TRUE)
r3 <- read.csv("r3.csv", header = TRUE)
r4 <- read.csv("r4.csv", header = TRUE)
r5 <- read.csv("r5.csv", header = TRUE)
r6 <- read.csv("r6.csv", header = TRUE)
r7 <- read.csv("r7.csv", header = TRUE)
r8 <- read.csv("r8.csv", header = TRUE)
r9 <- read.csv("r9.csv", header = TRUE)
r10 <- read.csv("r10.csv", header = TRUE)
r11 <- read.csv("r11.csv", header = TRUE)
r12 <- read.csv("r12.csv", header = TRUE)
```

Dane wczytują się z dodatkową pustą kolumną więc ja usuwam:
```{r cache=TRUE}
r1<-r1[,-14]
r2<-r2[,-14]
r3<-r3[,-14]
r4<-r4[,-14]
r5<-r5[,-14]
r6<-r6[,-14]
r7<-r7[,-14]
r8<-r8[,-14]
r9<-r9[,-14]
r10<-r10[,-14]
r11<-r11[,-14]
r12<-r12[,-14]
```

Ustawiam dodatkową kolumnę jako "znacznik", który jest dodatkową informacją z której reklamy pochodzą dane:
```{r cache =TRUE}
r1[, "ad_id"] <- rep(1, nrow(r1))
r2[, "ad_id"] <- rep(2, nrow(r2))
r3[, "ad_id"] <- rep(3, nrow(r3))
r4[, "ad_id"] <- rep(4, nrow(r4))
r5[, "ad_id"] <- rep(5, nrow(r5))
r6[, "ad_id"] <- rep(6, nrow(r6))
r7[, "ad_id"] <- rep(7, nrow(r7))
r8[, "ad_id"] <- rep(8, nrow(r8))
r9[, "ad_id"] <- rep(9, nrow(r9))
r10[, "ad_id"] <- rep(10, nrow(r10))
r11[, "ad_id"] <- rep(11, nrow(r11))
r12[, "ad_id"] <- rep(12, nrow(r12))
```

Wszystkie te dane umieszczam w jednym pliku:
```{r cache=TRUE}
dane <- rbind(r1,r2)
dane <- rbind(dane, r3)
dane <- rbind(dane, r4)
dane <- rbind(dane, r5)
dane <- rbind(dane, r6)
dane <- rbind(dane, r7)
dane <- rbind(dane, r8)
dane <- rbind(dane, r9)
dane <- rbind(dane, r10)
dane <- rbind(dane, r11)
dane <- rbind(dane, r12)
```
Zapisuję dane w pliku
```{r cache=TRUE}
saveRDS(dane, file = "dane.rda")
```

Dlaczego nie możemy skorzystać z wbudowanej funkcji randomForest? Na przykładzie obserwacji dla reklamy nr 1.

```{r cache=TRUE, error=TRUE}
require("randomForest")
model<-randomForest(wynik~.,r1, na.action = na.omit )
```
Niektóre ze zmiennych są kategoryczne i posiadają więcej niż 52 poziomy. Funkcja "randomForest" nie radzi sobie z taką ilością poziomów. Nie ma takiego problemu dla drzew, spójrzmy na przykład:

```{r cache=TRUE,error=TRUE}
require("rpart")
model<-rpart(wynik~.,r1)
```

Podejście, które stosuję jest następujące: <br>
1. Budowanie M drzew za pomocą funkcji "rpart"<br>
2. Klasyfikacja obserwacji za pomocą zbudowanych M drzew. Każde z nich zwraca prawdopodobieństwo przynależności obserwacji do grupy osób które odpowiedziały na reklamę ("tak") i do grupy która nie odpowie na reklamę ("nie")
W wyniku działania mamy M prawdopodobieństw że obserwacja (klasyfikowany człowiek) odpowie na reklamę pozytywnie (przynależność do grupy "tak"). Uśrednienie prawdopodobieństw.<br>
3. Procedura zostaje wykonana dla 12 reklam, Ostatecznie mamy 12 prawdopodobieństw (dla każdej reklamy) że obserwacja będzie przynależała do grupy "tak".<br>

Procedura która zbuduje model (później używany do predykcji prawdopodobieństwa że dana osoba odpowie pozytywnie na reklamę), dla pojedyńczej reklamy. <br>
input:<br>
data - plik z danymi na podstawie których budowany jest klasyfikator <br>
M - ilość drzew budowanych na potrzeby klasyfikacji <br>
n - ilość obserwacji pozytywnych i negatywnych w zbiorze testowym. <br>
output: <br>
models - wektor zawierający M zbudowanych klasyfikatorów typu drzewo
```{r cache=TRUE}
buduj_las<- function(data, M=500, n = 35){

  models<- vector(mode = "list", length = M)
  pos_index<- which(data$wynik=="tak")
  neg_index<- which(data$wynik=="nie")
  for(i in 1:M){
    
    uczacy_pos<- sample(pos_index, n, replace = TRUE)
    uczacy_neg<- sample(neg_index, n, replace = TRUE)
    uczacy<- rbind(data[uczacy_pos,],data[uczacy_neg,])
    
    models[[i]]<-rpart(wynik~plec+miasto_kat+wojewodztwo+domena_kat+wiek+
                         typ_adresu+poczta,data = uczacy, control = rpart.control(maxdepth = 20))
    
  }
  return(models)
}

```

Funkcja która zwraca prawdopodobieństwa pozytywnej odpowiedzi na każdą z reklam:<br>
input: <br>
obs - obserwacja do zaklasyfikowania <br>
allmodels - wektor zawierający 12 wektorów klasyfikatorów zbudowanych za pomocą funckji *buduj_las*
output: <br>
p_tak - wektor prawdopodobienst pozytywnej reakcji na każdą z reklam przez obserwację
```{r cache=TRUE}
klasyfikuj_obserwacje<- function(obs, allmodels){
  
  p_tak = numeric(length(allmodels))
  
  for(i in 1:length(allmodels)){
    tak = 0
    for(j in 1:length(allmodels[[i]])){
      
      attr<-attr(allmodels[[i]][[j]], "xlevels")
      for(nazwa in names(attr)){
        
        if(!(obs[,nazwa]%in%attr[[nazwa]])){
          obs[,nazwa] = as.factor(NA)
        }
      }
      tak = tak + predict(allmodels[[i]][[j]] ,obs)[,"tak"]
    }
    p_tak[i]= tak/(length(allmodels[[i]]))
  }
  return(p_tak)
}
```
Funkcja która pozwala na zbudowanie klasyfikatora i przetestowanie rozwiązania<br><br>
input:<br>
M- liczba drzew budowanych dla każdej reklamy <br>
n - liczba obserwacji pozytywnych i negatywnych użytych do uczenia pojedynczego drzewa
neg_test - liczba obserwacji negatywnych które później zostaną użyte do testów. Z całej reszty obserwacji budowany jest las (klasyfikator typu las dla reklamy)<br>
allmodelsRDS - nazwa pliku w którym zapisywany jest zbudowany model<br> 
testowyRDS - nazwa pliku w którym zapisany jest zbiór użyty do testów <br>
predykcjeRDS - nazwa pliku w którym zapisywane są predykcje <br>
logRDS - nazwa pliku w którym zapisywane są "logi", dotyczące głównie objętości każdego z utworzonych komponentów
<br><br>
output: <br>
wynik_tablica - confusion matrix dla predykcje vs realne klasy dla negatywnych obserwacji
```{r cache=TRUE}
require("stringr")
testuj<- function(M = 500,n = 35, neg_test = 1000, allmodelsRDS = "allmodels.rda", 
                  testowyRDS = "testowy.rda", predykcjeRDS = "predykcje.rda",
                  logRDS = "log.rda"){
  #budowanie klasyfikatora 
  allmodels<- vector(mode = "list", length = 12)
  reklamy<-c("r1","r2","r3","r4","r5","r6","r7","r8","r9","r10","r11","r12")
  testowy<- data.frame("id" = c(), "plec"=c(),"miasto_kat"=c(), "wojewodztwo"= c(),
                       "domena_kat"= c(), "wiek"= c(),"IPA"= c(), "IPB" = c() ,
                       "wynik" = c(), "typ_adresu" = c(), "wybory" = c(), 
                       "poczta" = c(), "data" = c(), "ad_id" = c())
  
  for(i in 1:length(allmodels)){
    
    #uczymy każde drzewo na 35 elementach poz i 35 neg ze zwracaniem, testujemy na 1000 neg
    testowy_neg<- sample(which(get(reklamy[i])$wynik=="nie"), neg_test)
    testowy<- rbind(testowy, get(reklamy[i])[testowy_neg,])
    allmodels[[i]]<-buduj_las(get(reklamy[i])[-testowy_neg,],M=M,n )
    saveRDS(allmodels, file = allmodelsRDS)
    saveRDS(testowy, file = testowyRDS)
    saveRDS((sort( sapply(ls(),function(x){object.size(get(x))}))),file = logRDS)
  }
  predykcje<- numeric(nrow(testowy))
  for(i in 1:nrow(testowy)){
    
    predykcje[i]<- which.max(klasyfikuj_obserwacje(testowy[i,], allmodels))
    saveRDS(predykcje, file = predykcjeRDS)
    saveRDS((sort( sapply(ls(),function(x){object.size(get(x))}))),file = logRDS)
    
  }
  wynik_tablica <- table(predykcje,testowy$ad_id)
  return(wynik_tablica)
}

```
Funkcja która pozwala na testowanie dwóch zapisanych na dysku klasyfikatorach na tym samym zbiorze testowym. (przydatna przy porównywaniu)<br>
<br>
input:<br>
k1file - nazwa pliku w którym jest zapisany klasyfikator 1<br>
k2file - nazwa pliku w ktorym jest zapisany klasyfikator 2<br>
pred1file - nazwa pliku w ktorym zostana zapisane predykcje klas przez klasyfikator 1<br>
pred2file - nazwa pliku w ktorym zostana zapisane predykcje klas przez klasyfikator 2<br>
testowyfile - nazwa pliku w ktorym zostanie zapisany użyty zbiór testowy <br>
n_poz - liczba obserwacji pozytywnych które zostaną użyte w zbiorze testowym<br>
n_neq - liczba obserwacji negatywnych które zostaną użyte w zbiorze testowym<br>
daneRDS nazwa pliku w którym zapisany został zbiór danych
```{r cache=TRUE}
testuj_3<-function(k1file = "am2.rda", k2file = "am2_1.rda", pred1file = "pred1.rda",
                   pred2file = "pred2.rda", testowyfile = "testowy.rda",
                   n_poz = 1000, n_neq = 2000, daneRDS = "dane.rda"){
  
  require("rpart")
  dane <- readRDS(file = daneRDS)
  testowy<- rbind(dane[sample(which(dane$wynik=="nie"),n_poz),],
                   dane[sample(which(dane$wynik=="tak"),n_poz),])
  pred1<- numeric(length(testowy[,1]))
  pred2<- numeric(length(testowy[,1]))
  
  saveRDS(testowy, file = testowyfile)
  
  rm(dane)
  
  k1<- readRDS(file = k1file)
  k2<- readRDS(file = k2file)
  
  for(i in 1:length(pred1)){
    
    pred1[i]<- which.max(klasyfikuj_obserwacje(testowy[i,],k1))
    pred2[i]<- which.max(klasyfikuj_obserwacje(testowy[i,],k2))
    saveRDS(pred1, file = pred1file)
    saveRDS(pred2, file = pred2file)
  }
}

```

W przesłanym folderze znajdują się pliki z wyuczonymi klasyfikatorami, zbiorami testowymi oraz predykcjami dla zbiorów testowych.<br><br>
**am4.rda** <- klasyfikator skladający się z 50 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : "plec","miasto_kat","wojewodztwo",  "domena_kat", "wiek", "typ_adresu"i "poczta" <br><br>
**am4_1.rda** <- klasyfikator skladający się z 50 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : wszytskie dostępne <br><br>
**am3.rda** <- klasyfikator skladający się z 100 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : "plec","miasto_kat","wojewodztwo",  "domena_kat", "wiek", "typ_adresu"i "poczta" <br><br>
**am3_1.rda** <- klasyfikator skladający się z 100 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : wszystkie dostępne <br><br>
**am2.rda** <- klasyfikator skladający się z 200 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : "plec","miasto_kat","wojewodztwo",  "domena_kat", "wiek", "typ_adresu"i "poczta" <br><br>
**am2_1.rda** <- klasyfikator skladający się z 200 drzew dla każdej reklamy, każde drzewo uczone za pomocą 35 obserwacji pozytywnych i 35 obserwacji negatywnych (losowanych ze zbioru testowego ze zwracaniem). Zmienne zależne : wszystkie dostępne<br><br>

**Przykładowe wywołanie** <br>
Wczytujemy klasyfikator
```{r cache=TRUE}
am3<- readRDS(file = "am3.rda")
```
Wybieramy obserwację  i klasyfikujemy ją.
```{r cache=TRUE}
r4[1024,]
ptm <- proc.time()
klasyfikuj_obserwacje(r4[1024,], am3)
proc.time() - ptm
```
Powyżej widzimy wektor prawdopodobieństw pozytywnej odpowiedzi na każdą z reklam przez wybraną obserwację (tutaj przykładowo obserwacja nr 1024 z reklamy nr 4). Obserwacja pochodzi z reklamy 4 i odpowiedziała na nią negatywnie (wynik=="nie"). Klasyfikator przewidział prawdopodobieństwo pozytywnej odpowiedzi dla reklamy 4 na poziomie 45%. Klasyfikator wyestymował największe prawdopodobieństwo pozytywnej odpowiedzi przez obserwację na reklamę nr 7 i jest ono na poziomie 71,7%. Gdybyśmy przed pokazaniem  obserwacji reklamy wzięli pod uwagę informacje z klasyfikatora to nie pokazalibyśmy jej reklamy nr 4 (na którą wiemy że nie odpowiedziała) tylko reklamę nr 7 (dla której prawdpodobieństwo odpowiedzi pozytywnej jest znacznie większe zatem mamy większe szanse, że obserwacja ostatecznie dokonałaby zakupu).</br></br><br>

Jeśli chcemy zobaczyć przykładowy wynik wywołania dla losowej obserwacji  wystarczy wywołać
```{r cache=TRUE}
i<-sample(nrow(dane),1)
dane[i,] 
klasyfikuj_obserwacje(dane[i,], am3)
```
Dla losowej obserwacji pozytywnej:
```{r cache=TRUE}
i<-sample(which(dane$wynik=="tak"),1)
dane[i,]
klasyfikuj_obserwacje(dane[i,], am3)
```
Dla losowej obserwacji negatywnej:
```{r cache=TRUE}
i<-sample(which(dane$wynik=="nie"),1)
dane[i,]
klasyfikuj_obserwacje(dane[i,], am3)
```
**Przykladowe Testy**<br><br>
Testy opierały się na badaniu wyników klasyfikacji dla osób które odpowiedziały negatywnie na pokazaną reklamę. Mają one na celu pokazać jak często używając danego klasyfikatora nie popełnilibyśmy błędu pokazując reklamę którą badany człowiek nie jest zainteresowany. Liczba negatywnych obserwacji losowanych z całego zbioru do zbioru testowego : 2000
<br><br>
**Dla klasyfikatora am4**. Poniżej znajduje się "confusion matrix" , predykcje jako wiersze, prawdziwe klasy jako kolumny
```{r cache=TRUE}
testowy4<-readRDS(file = "testowy4.rda")
pred1am4<- readRDS(file = "pred1am4.rda")
pred2am4_1<- readRDS(file = "pred2am4_1.rda")
indeks<-which(testowy4$wynik=="nie")
tabela<-table(pred1am4[indeks], testowy4[indeks,"ad_id"])
tabela

```
Procent osób dla których klasyfikator jako pierwsza pokazałby inna reklame niż została pokazana:
```{r cache=TRUE}
1-sum(diag(tabela))/sum(tabela)
```

**Dla klasyfikatora am4_1**
```{r cache=TRUE}
tabela<-table(pred2am4_1[indeks], testowy4[indeks,"ad_id"])
tabela
```

Procent osób dla których klasyfikator jako pierwsza pokazałby inna reklame niż została pokazana:
```{r cache=TRUE}
1-sum(diag(tabela))/sum(tabela)
```

**Dla klasyfikatora am3**
```{r cache=TRUE}
testowy3<-readRDS(file = "testowy3.rda")
pred1am3<- readRDS(file = "pred1am3.rda")
pred2am3_1<- readRDS(file = "pred2am3_1.rda")
indeks<-which(testowy3$wynik=="nie")
tabela<-table(pred1am3[indeks], testowy3[indeks,"ad_id"])
tabela

```
Procent osób dla których klasyfikator jako pierwsza pokazałby inna reklame niż została pokazana:
```{r cache=TRUE}
1-sum(diag(tabela))/sum(tabela)
```

**Dla klasyfikatora am3_1**
```{r cache=TRUE}
tabela<-table(pred2am3_1[indeks], testowy3[indeks,"ad_id"])
tabela
```

Procent osób dla których klasyfikator jako pierwsza pokazałby inna reklame niż została pokazana:
```{r cache=TRUE}
1-sum(diag(tabela))/sum(tabela)
```
Można zauważyć że używając któregokolwiek z tych klasyfikatorów znacząca większość obserwacji które zareagowały negatywnie na losowo pokazaną reklamę dostałaby inną reklamę o większym prawdopodobieństwie pozytywnej reakcje, co oznacza że zwiększamy prawdopodobieństwo że obserwacja zareaguje pozytywnie.


